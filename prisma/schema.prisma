// Prisma schema for gold/abshodeh trading backend
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  TRADER
  CLIENT
}

enum UserStatus {
  ACTIVE
  BLOCKED
  PENDING_APPROVAL
}

enum InstrumentType {
  FIAT
  GOLD
  COIN
  OTHER
}

enum InstrumentUnit {
  GRAM_750_EQ
  PIECE
  CURRENCY
}

enum TradeSide {
  BUY
  SELL
}

enum TradeStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED_BY_USER
  CANCELLED_BY_ADMIN
  SETTLED
}

enum SettlementMethod {
  WALLET
  EXTERNAL
  CASH
}

enum TxRefType {
  TRADE
  DEPOSIT
  WITHDRAW
  ADJUSTMENT
  GOLD_LOT
  // TODO: Introduce a Remittance entity/service to cover internal transfers.
  REMITTANCE
}

enum AccountTxType {
  DEPOSIT
  WITHDRAW
  TRADE_DEBIT
  TRADE_CREDIT
  ADJUSTMENT
  FEE
  REMITTANCE
}

enum DepositStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum WithdrawStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum GoldLotStatus {
  IN_VAULT
  SOLD
  WITHDRAWN
  MELTED
}

enum AttachmentEntityType {
  TRADE
  DEPOSIT
  WITHDRAW
  GOLD_LOT
  // TODO: Attachments for remittance flows will use this type once implemented.
  REMITTANCE
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fullName String
  mobile   String @unique
  password String
  email    String @unique

  role   UserRole   @default(CLIENT)
  status UserStatus @default(PENDING_APPROVAL)

  accounts  Account[]
  trades    Trade[]     @relation("UserTrades")
  createdTx AccountTx[] @relation("TxCreatedBy")

  // سمت "صاحب درخواست"‌ها
  deposits  DepositRequest[]  @relation("UserDeposits")
  withdraws WithdrawRequest[] @relation("UserWithdraws")

  // سمت "پردازش کننده"‌ها (ادمین‌ها)
  processedDeposits  DepositRequest[]  @relation("DepositProcessedBy")
  processedWithdraws WithdrawRequest[] @relation("WithdrawProcessedBy")

  remittancesSent     Remittance[] @relation("RemittanceFrom")
  remittancesReceived Remittance[] @relation("RemittanceTo")

  // سمت "تریدهای تاییدشده توسط این کاربر (ادمین)"
  approvedTrades Trade[] @relation("ApprovedTrades")

  goldLots GoldLot[]
  files    File[]    @relation("FilesUploadedBy")
}

model Instrument {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  code String         @unique
  name String
  type InstrumentType
  unit InstrumentUnit

  accounts Account[]
  trades   Trade[]
  prices   InstrumentPrice[]
  remittances Remittance[]
}

model InstrumentPrice {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  instrument   Instrument @relation(fields: [instrumentId], references: [id])
  instrumentId String

  buyPrice  Decimal @db.Decimal(18, 4)
  sellPrice Decimal @db.Decimal(18, 4)
  source    String?
}

model Account {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  instrument   Instrument @relation(fields: [instrumentId], references: [id])
  instrumentId String

  balance        Decimal @db.Decimal(24, 6)
  blockedBalance Decimal @default(0) @db.Decimal(24, 6)
  minBalance     Decimal @default(0) @db.Decimal(24, 6)

  transactions AccountTx[]

  @@unique([userId, instrumentId])
}

model AccountTx {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  account   Account @relation(fields: [accountId], references: [id])
  accountId String

  delta Decimal @db.Decimal(24, 6)

  type    AccountTxType
  refType TxRefType
  refId   String?

  createdBy   User?   @relation("TxCreatedBy", fields: [createdById], references: [id])
  createdById String?

  depositRequests  DepositRequest[]  @relation("DepositAccountTx")
  withdrawRequests WithdrawRequest[] @relation("WithdrawAccountTx")

  remittanceFrom Remittance? @relation("RemittanceFromTx")
  remittanceTo   Remittance? @relation("RemittanceToTx")

  @@index([refType, refId])
}

model Trade {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client   User   @relation("UserTrades", fields: [clientId], references: [id])
  clientId String

  instrument   Instrument @relation(fields: [instrumentId], references: [id])
  instrumentId String

  side             TradeSide
  status           TradeStatus      @default(PENDING)
  settlementMethod SettlementMethod

  quantity     Decimal @db.Decimal(24, 6)
  pricePerUnit Decimal @db.Decimal(24, 6)
  totalAmount  Decimal @db.Decimal(24, 6)

  clientNote String?
  adminNote  String?

  approvedAt   DateTime?
  approvedBy   User?     @relation("ApprovedTrades", fields: [approvedById], references: [id])
  approvedById String?

  rejectedAt   DateTime?
  rejectReason String?
}

model DepositRequest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation("UserDeposits", fields: [userId], references: [id])
  userId String

  amount Decimal       @db.Decimal(24, 2)
  method String
  status DepositStatus @default(PENDING)

  refNo         String?
  note          String?
  processedAt   DateTime?
  processedBy   User?     @relation("DepositProcessedBy", fields: [processedById], references: [id])
  processedById String?

  accountTx   AccountTx? @relation("DepositAccountTx", fields: [accountTxId], references: [id])
  accountTxId String?
}

model WithdrawRequest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation("UserWithdraws", fields: [userId], references: [id])
  userId String

  amount Decimal        @db.Decimal(24, 2)
  status WithdrawStatus @default(PENDING)

  bankName   String?
  iban       String?
  cardNumber String?

  note          String?
  processedAt   DateTime?
  processedBy   User?     @relation("WithdrawProcessedBy", fields: [processedById], references: [id])
  processedById String?

  accountTx   AccountTx? @relation("WithdrawAccountTx", fields: [accountTxId], references: [id])
  accountTxId String?
}

model Remittance {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  fromUser   User   @relation("RemittanceFrom", fields: [fromUserId], references: [id])
  fromUserId String

  toUser   User   @relation("RemittanceTo", fields: [toUserId], references: [id])
  toUserId String

  instrument   Instrument @relation(fields: [instrumentId], references: [id])
  instrumentId String

  amount Decimal @db.Decimal(24, 6)
  note   String?

  fromAccountTx   AccountTx? @relation("RemittanceFromTx", fields: [fromAccountTxId], references: [id])
  fromAccountTxId String?  @unique

  toAccountTx   AccountTx? @relation("RemittanceToTx", fields: [toAccountTxId], references: [id])
  toAccountTxId String?  @unique
}

model GoldLot {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  userId String

  grossWeight  Decimal @db.Decimal(24, 6)
  karat        Int
  equivGram750 Decimal @db.Decimal(24, 6)

  status GoldLotStatus @default(IN_VAULT)

  note String?
}

model File {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  uploadedBy   User   @relation("FilesUploadedBy", fields: [uploadedById], references: [id])
  uploadedById String

  storageKey String
  fileName   String
  mimeType   String
  sizeBytes  Int

  label String?

  attachments Attachment[]
}

model Attachment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  file   File   @relation(fields: [fileId], references: [id])
  fileId String

  entityType AttachmentEntityType
  entityId   String

  purpose String?
}
